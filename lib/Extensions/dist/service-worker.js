(function () {
	'use strict';

	chrome.action.onClicked.addListener(function(){chrome.tabs.create({url:chrome.runtime.getURL("index.html")});});class T{constructor(a,o,t=null,i=!0){this.url=a,this.xpath=o,this.secondaryXPath=t,this.autoClose=i,this.tabId=null;}openAndClick(a){chrome.tabs.create({url:this.url,active:!1},o=>{if(chrome.runtime.lastError||!(o!=null&&o.id))return a("fail",null);this.tabId=o.id;let t=!1;const i=setTimeout(()=>{t||(t=!0,this.closeTab(),a("timeout",this.tabId));},100*1e3),n=(u,l)=>{u===this.tabId&&l.status==="complete"&&!t&&(t=!0,clearTimeout(i),chrome.tabs.onUpdated.removeListener(n),setTimeout(()=>this.executeClick(this.tabId,a),2e3));};chrome.tabs.onUpdated.addListener(n);});}closeTab(){this.tabId&&chrome.tabs.remove(this.tabId,()=>{chrome.runtime.lastError&&console.error("Error closing tab:",chrome.runtime.lastError);});}executeClick(a,o){chrome.scripting.executeScript({target:{tabId:a},func:(t,i)=>new Promise(n=>{function u(e){try{return document.evaluate(e,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue}catch{return null}}function l(e,r=15e3){return new Promise(s=>{const f=Date.now(),h=()=>{const d=u(e);if(d&&d.offsetWidth>0&&d.offsetHeight>0)return s(d);if(Date.now()-f>=r)return s(null);setTimeout(h,500);};h();})}function p(e){return new Promise(r=>{e.scrollIntoView({behavior:"smooth",block:"center"}),setTimeout(()=>{const s=e.getBoundingClientRect(),f=s.left+s.width/2,h=s.top+s.height/2;["mouseenter","mouseover","mousedown","mouseup","click"].forEach((d,g)=>{setTimeout(()=>{e.dispatchEvent(new MouseEvent(d,{bubbles:!0,cancelable:!0,view:window,clientX:f+Math.random()*2-1,clientY:h+Math.random()*2-1}));},g*50);}),setTimeout(()=>r(!0),300);},1e3);})}function m(e){const r=u(e);if(!r)return;const s=new MutationObserver(()=>{const f=r.getAttribute("tabindex"),h=r.getAttribute("aria-disabled");f==="0"&&h!=="true"&&(s.disconnect(),setTimeout(()=>p(r),800));});console.log("121212"),s.observe(r,{attributes:!0}),setTimeout(()=>s.disconnect(),5e4);}(async()=>{try{await new Promise(r=>setTimeout(r,1500));const e=await l(t);if(!e)return n("not_found");console.log("Success: ",e),await p(e),console.log("Success 1: ",e),i?(setTimeout(()=>m(i),3e3),n("primary_clicked_watching")):n("success");}catch{n("error");}})();}),args:[this.xpath,this.secondaryXPath]},t=>{if(chrome.runtime.lastError||!(t!=null&&t[0]))o("injection_error",this.tabId);else {const i=t[0].result||"unknown";o(i,this.tabId);}});}}const b=new Map;chrome.runtime.onMessage.addListener((c,a,o)=>{if(c.type==="click_request"){const{url:t,primaryXPath:i,secondaryXPath:n,autoClose:u=!0}=c.payload;if(!t||!i)return o({status:"fail",error:"Missing parameters"}),!1;const l=new T(t,i,n,u),p=setTimeout(()=>{const m={status:"timeout",timestamp:Date.now(),tabId:l.tabId};o(m),w(m);},45e3);return l.openAndClick((m,e)=>{clearTimeout(p);const r={status:m,timestamp:Date.now(),url:t,primaryXPath:i,secondaryXPath:n,tabId:e,autoClose:u};e&&b.set(e,{url:t,clicker:l,timestamp:Date.now()}),console.log(r),o(r),w(r);}),!0}if(c.type==="close_tab"){const{tabId:t}=c.payload;return console.log("tabId1:",t),t&&b.has(t)?(b.get(t).clicker.closeTab(),b.delete(t),o({status:"tab_closed",tabId:t})):o({status:"tab_not_found",tabId:t}),!0}if(c.type==="get_active_tabs"){const t=Array.from(b.entries()).map(([i,n])=>({tabId:i,url:n.url,timestamp:n.timestamp}));return o({status:"success",tabs:t}),!0}return !1});function w(c){chrome.runtime.sendMessage({type:"click_result_notification",payload:c}).catch(()=>{});}

})();
