(()=>{"use strict";const e={API_KEY:{key:"api_key",defaultValue:""},APP_ID:{key:"appId",defaultValue:""},POWER_ON:{key:"power_on",defaultValue:!0},TIKTOK:{key:"tiktok",defaultValue:{delayClick:500,delaySwipe:15,loop:!0,isActive:!0}},FUNCAPTCHA:{key:"funcaptcha",defaultValue:{delayClick:100,loop:!0,isActive:!0,maxImageCaptcha:25}},ZALO:{key:"zalo",defaultValue:{delayClick:100,loop:!0,isActive:!0}},SHOPEE:{key:"shopee",defaultValue:{delaySwipe:15,loop:!0,isActive:!0}},RECAPTCHAV2:{key:"reCaptchav2",defaultValue:{delayClick:500,loop:!0,isActive:!0,useToken:!1}},AMZN:{key:"amzn",defaultValue:{delayClick:100,loop:!0,isActive:!0}},GEETEST:{key:"geetest",defaultValue:{delayClick:500,delaySwipe:15,loop:!0,isActive:!0}},SLIDE_ALL:{key:"slide_all",defaultValue:{delaySwipe:15,loop:!0,isActive:!0}},HCAPTCHA:{key:"hcaptcha",defaultValue:{delayClick:500,delaySwipe:15,loop:!0,isActive:!0}},CLOUDFLARE:{key:"cloudflare",defaultValue:{delayClick:2e3,isActive:!0}}},t=async(e,t)=>{const o="undefined"!=typeof browser?browser.storage.local:chrome.storage.local,a="undefined"!=typeof browser?browser.runtime:chrome.runtime;try{const n=await o.get([e]);if(a.lastError)throw new Error(`Error retrieving ${e}: ${a.lastError.message}`);return null!=n[e]?n[e]:t}catch(t){throw console.error(`[storageHelpers] Error retrieving ${e}:`,t),t}};Promise.resolve();async function o(e,t,o){const a="undefined"!=typeof browser?browser.runtime:chrome.runtime;try{return await new Promise(((n,r)=>{a.sendMessage({source:e,type:t,data:o},(e=>{a.lastError?r(new Error(`Error sending message: ${a.lastError.message}`)):n(e)}))}))}catch(e){throw console.error(`[messageHelpers] Error in sending message: ${e.message}`),e}}async function a(e){return new Promise((t=>setTimeout(t,e)))}function n(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"success",o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,a=document.getElementById("captcha-message");a||(a=document.createElement("div"),a.id="captcha-message",a.style.zIndex="99999999",a.style.padding="3px 3px",a.style.borderRadius="3px",a.style.boxShadow="0 2px 10px rgba(0, 0, 0, 0.2)",a.style.fontSize="10px",a.style.fontWeight="600",a.style.fontFamily="Arial, sans-serif",a.style.textAlign="center",a.style.whiteSpace="nowrap",a.style.color="white",a.style.top="1px",o&&o.parentElement?(a.style.position="absolute",a.style.left="2px",o.parentElement.appendChild(a)):(a.style.position="fixed",a.style.left="1px",document.body.appendChild(a)));const n={success:"linear-gradient(90deg, #1e90ff, #00c4ff)",error:"linear-gradient(90deg, #ff5e62, #ff9966)",warning:"linear-gradient(90deg, #ffbb33, #ff9500)",info:"linear-gradient(90deg, #2193b0, #6dd5ed)"};a.innerText="[GEMcaptcha.com] "+e,a.style.background=n[t]||n.success,a.style.display="block"}async function r(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{timeout:5e3,maxRetries:3};try{const{timeout:o,maxRetries:n}=t,r={arkoselabs:"image/jpeg"};function s(e){for(const[t,o]of Object.entries(r))if(e.includes(t))return o;return"image/png"}if(e instanceof HTMLCanvasElement||e.tagName&&"CANVAS"===e.tagName.toUpperCase())try{if(0===e.width||0===e.height)return console.log("Canvas rỗng hoặc không có kích thước"),"";const l=e.getBoundingClientRect(),i=l.width,c=l.height,u=document.createElement("canvas");u.width=i,u.height=c;u.getContext("2d").drawImage(e,0,0,i,c);const d="image/png",f=u.toDataURL(d).split(",")[1];return f||(console.log("Không thể lấy base64 từ canvas"),"")}catch(g){return console.log("Lỗi khi chụp màn hình canvas:",g),""}if(e instanceof Element)try{const y=e.src;if(y&&y.startsWith("data:image/")){const m=y.split(",")[1];return m||(console.log("Base64 rỗng từ src của element"),"")}e=y||""}catch(h){return console.log("Lỗi khi xử lý element:",h),""}if("string"==typeof e&&e.startsWith("blob:")){console.log("Da vao blob");try{return await new Promise((t=>{const o=new Image;o.setAttribute("crossOrigin","anonymous");const a=setTimeout((()=>{t("")}),1e3);o.onload=function(){console.log("Vao trong onload"),clearTimeout(a);try{const o=document.createElement("canvas");o.width=this.naturalWidth,o.height=this.naturalHeight;o.getContext("2d").drawImage(this,0,0);const a=s(e);o.toBlob((e=>{if(!e)return void t("");const o=new FileReader;o.onloadend=()=>{const e=o.result.split(",")[1];t(e)},o.onerror=()=>t(""),o.readAsDataURL(e)}),a)}catch(e){console.log("Lỗi khi xử lý blob URL:",e),t("")}},o.onerror=()=>{clearTimeout(a),t("")},o.src=e,console.log("This is img:"),console.log("img src:",o.src)}))}catch(p){return console.log("Lỗi khi xử lý blob URL:",p),""}}if("string"==typeof e){console.log("Vao den input string:");try{for(let w=0;w<n;w++)try{const k=new AbortController,b=setTimeout((()=>k.abort()),o),v=await fetch(e,{signal:k.signal});if(clearTimeout(b),!v.ok)throw new Error(`HTTP error ${v.status}`);const A=await v.blob();return await new Promise(((e,t)=>{const o=new FileReader;o.onloadend=()=>e(o.result.split(",")[1]),o.onerror=()=>t(new Error("Failed to read blob as base64")),o.readAsDataURL(A)}))}catch(E){if(w===n-1)return console.log("Hết lượt thử fetch:",E),"";await a(500)}}catch(C){return console.log("Lỗi khi fetch URL:",C),""}}return console.log("Đầu vào không được hỗ trợ:",e),""}catch(S){return console.log("Lỗi chung trong fetchImageToBase64:",S),""}}async function s(e){console.log("Vao createTask utils");try{const t=await o("SOURCE","createTask",e);return t||(console.error("No response from createTask"),"")}catch(e){return console.error("Failed to create task:",e),""}}async function l(e,t,a){const n=JSON.stringify({clientKey:e,taskId:t});try{const e=await o("SOURCE","getTaskResult",{data:n,timeWait:a});return e?"fail"===e.status?(console.error("API error:",e),{errorDescription:e.errorDescription}):e.solution?e.solution:e.type?e:(console.error("Invalid API response: missing solution"),null):(console.error("No result returned from getTaskResult"),null)}catch(e){return console.error("Failed to get task result:",e),null}}let i,c,u,d,f;async function g(){i=await t(e.POWER_ON.key,e.POWER_ON.defaultValue),c=await t(e.API_KEY.key,e.API_KEY.defaultValue);const o=await t(e.AMZN.key,e.AMZN.defaultValue);u=o.delayClick,d=o.loop,f=o.isActive}console.log("File amzn");let y=!1,m="";async function h(){for(let t=0;t<30;t++){await a(1e3);if(!await p(['[id*="captcha"] [class*="amzn"] canvas'],1e4))return;const t=document.querySelector('[id*="captcha"] [class*="amzn"] em[style*="text"]');if(!t)return;const o=t.textContent;console.log(o);var e=document.querySelector('[id*="captcha"] [class*="amzn"] canvas');if(!e)return void console.log("[Amzn] Khong thay canvas");n("Captcha select object","red",e),console.log("[Amzn] Canvas",e);let i="";for(let t=0;t<10;t++){if(i=await r(e,{timeout:5e3,maxRetries:3}),i&&m!==i){m=i;break}await a(1e3)}if(!i)return;console.log(i);const f=JSON.stringify({clientKey:c,task:{type:"AmznSelectObjectTask",imageBase64:i,other:o}}),g=await s(f);if(console.log("[Amzn] This is response",g),!g||g.error){if(n(g?g.errorDescription:"No response","red",e),d){document.querySelector('[id*="amzn-btn-refresh"][type="button"]').click();continue}}else{const t=await l(c,g.taskId,30);if(!t||t.errorDescription){if(n(t?t.errorDescription:"No result from API","red",e),d){document.querySelector('[id*="amzn-btn-refresh"][type="button"]').click();continue}return}console.log("[Amzn] Kết quả:",t),n("Solving...","red",e);for(let e=0;e<t.objects.length;e++){e>0&&await a(u);let o=t.objects[e],n=parseInt(o,10);document.querySelectorAll('[class*="amzn"] canvas button')[n].click()}await a(1e3),document.querySelector('[id*="amzn-btn-verify"]').click(),await a(6e3)}}}async function p(e,t){const o=Date.now()+t;for(;Date.now()<o;){for(const t of e){if(document.querySelector(t))return!0}await a(500)}return!1}(async()=>{await g();new MutationObserver((async(e,t)=>{await async function(e){if(await g(),!i||!f||!c||"YOUR_CLIEN_KEY"===c)return;for(const t of e)if("childList"===t.type){if(document.querySelector('[id*="captcha"] [class*="amzn"] canvas')&&!y){if(!c)return;y=!0;try{await a(1e3),await h()}finally{y=!1}}}}(e)})).observe(document.body,{childList:!0,subtree:!0});for(let e=0;e<100;e++){const e=document.querySelector(".amzn-captcha-lang-selector");if(e){const t=e.value;if(t&&"en"!==t)e.value="en",e.dispatchEvent(new Event("change"));else{const e=document.querySelector('[id*="captcha"] button[class*="amzn"]');e&&!y&&(console.log("click"),e.click())}}await a(1e3)}})()})();