(()=>{"use strict";const e={API_KEY:{key:"api_key",defaultValue:""},APP_ID:{key:"appId",defaultValue:""},POWER_ON:{key:"power_on",defaultValue:!0},TIKTOK:{key:"tiktok",defaultValue:{delayClick:500,delaySwipe:15,loop:!0,isActive:!0}},FUNCAPTCHA:{key:"funcaptcha",defaultValue:{delayClick:100,loop:!0,isActive:!0,maxImageCaptcha:25}},ZALO:{key:"zalo",defaultValue:{delayClick:100,loop:!0,isActive:!0}},SHOPEE:{key:"shopee",defaultValue:{delaySwipe:15,loop:!0,isActive:!0}},RECAPTCHAV2:{key:"reCaptchav2",defaultValue:{delayClick:500,loop:!0,isActive:!0,useToken:!1}},AMZN:{key:"amzn",defaultValue:{delayClick:100,loop:!0,isActive:!0}},GEETEST:{key:"geetest",defaultValue:{delayClick:500,delaySwipe:15,loop:!0,isActive:!0}},SLIDE_ALL:{key:"slide_all",defaultValue:{delaySwipe:15,loop:!0,isActive:!0}},HCAPTCHA:{key:"hcaptcha",defaultValue:{delayClick:500,delaySwipe:15,loop:!0,isActive:!0}},CLOUDFLARE:{key:"cloudflare",defaultValue:{delayClick:2e3,isActive:!0}}};async function t(e,t,o){const r="undefined"!=typeof browser?browser.runtime:chrome.runtime;try{return await new Promise(((n,a)=>{r.sendMessage({source:e,type:t,data:o},(e=>{r.lastError?a(new Error(`Error sending message: ${r.lastError.message}`)):n(e)}))}))}catch(e){throw console.error(`[messageHelpers] Error in sending message: ${e.message}`),e}}const o=async(e,t)=>{const o="undefined"!=typeof browser?browser.storage.local:chrome.storage.local,r="undefined"!=typeof browser?browser.runtime:chrome.runtime;try{const n=await o.get([e]);if(r.lastError)throw new Error(`Error retrieving ${e}: ${r.lastError.message}`);return null!=n[e]?n[e]:t}catch(t){throw console.error(`[storageHelpers] Error retrieving ${e}:`,t),t}};Promise.resolve();async function r(e){return new Promise((t=>setTimeout(t,e)))}function n(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"success",o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=document.getElementById("captcha-message");r||(r=document.createElement("div"),r.id="captcha-message",r.style.zIndex="99999999",r.style.padding="3px 3px",r.style.borderRadius="3px",r.style.boxShadow="0 2px 10px rgba(0, 0, 0, 0.2)",r.style.fontSize="10px",r.style.fontWeight="600",r.style.fontFamily="Arial, sans-serif",r.style.textAlign="center",r.style.whiteSpace="nowrap",r.style.color="white",r.style.top="1px",o&&o.parentElement?(r.style.position="absolute",r.style.left="2px",o.parentElement.appendChild(r)):(r.style.position="fixed",r.style.left="1px",document.body.appendChild(r)));const n={success:"linear-gradient(90deg, #1e90ff, #00c4ff)",error:"linear-gradient(90deg, #ff5e62, #ff9966)",warning:"linear-gradient(90deg, #ffbb33, #ff9500)",info:"linear-gradient(90deg, #2193b0, #6dd5ed)"};r.innerText="[GEMcaptcha.com] "+e,r.style.background=n[t]||n.success,r.style.display="block"}async function a(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{timeout:5e3,maxRetries:3};try{const{timeout:o,maxRetries:n}=t,a={arkoselabs:"image/jpeg"};function i(e){for(const[t,o]of Object.entries(a))if(e.includes(t))return o;return"image/png"}if(e instanceof HTMLCanvasElement||e.tagName&&"CANVAS"===e.tagName.toUpperCase())try{if(0===e.width||0===e.height)return console.log("Canvas rỗng hoặc không có kích thước"),"";const c=e.getBoundingClientRect(),s=c.width,l=c.height,u=document.createElement("canvas");u.width=s,u.height=l;u.getContext("2d").drawImage(e,0,0,s,l);const d="image/png",h=u.toDataURL(d).split(",")[1];return h||(console.log("Không thể lấy base64 từ canvas"),"")}catch(g){return console.log("Lỗi khi chụp màn hình canvas:",g),""}if(e instanceof Element)try{const f=e.src;if(f&&f.startsWith("data:image/")){const m=f.split(",")[1];return m||(console.log("Base64 rỗng từ src của element"),"")}e=f||""}catch(p){return console.log("Lỗi khi xử lý element:",p),""}if("string"==typeof e&&e.startsWith("blob:")){console.log("Da vao blob");try{return await new Promise((t=>{const o=new Image;o.setAttribute("crossOrigin","anonymous");const r=setTimeout((()=>{t("")}),1e3);o.onload=function(){console.log("Vao trong onload"),clearTimeout(r);try{const o=document.createElement("canvas");o.width=this.naturalWidth,o.height=this.naturalHeight;o.getContext("2d").drawImage(this,0,0);const r=i(e);o.toBlob((e=>{if(!e)return void t("");const o=new FileReader;o.onloadend=()=>{const e=o.result.split(",")[1];t(e)},o.onerror=()=>t(""),o.readAsDataURL(e)}),r)}catch(e){console.log("Lỗi khi xử lý blob URL:",e),t("")}},o.onerror=()=>{clearTimeout(r),t("")},o.src=e,console.log("This is img:"),console.log("img src:",o.src)}))}catch(y){return console.log("Lỗi khi xử lý blob URL:",y),""}}if("string"==typeof e){console.log("Vao den input string:");try{for(let b=0;b<n;b++)try{const w=new AbortController,v=setTimeout((()=>w.abort()),o),k=await fetch(e,{signal:w.signal});if(clearTimeout(v),!k.ok)throw new Error(`HTTP error ${k.status}`);const C=await k.blob();return await new Promise(((e,t)=>{const o=new FileReader;o.onloadend=()=>e(o.result.split(",")[1]),o.onerror=()=>t(new Error("Failed to read blob as base64")),o.readAsDataURL(C)}))}catch(E){if(b===n-1)return console.log("Hết lượt thử fetch:",E),"";await r(500)}}catch(x){return console.log("Lỗi khi fetch URL:",x),""}}return console.log("Đầu vào không được hỗ trợ:",e),""}catch(A){return console.log("Lỗi chung trong fetchImageToBase64:",A),""}}function i(e){["pointerdown","mousedown","mouseup","click"].forEach((function(t){e.dispatchEvent(new MouseEvent(t,{bubbles:!0,cancelable:!0,view:window}))}))}let c,s,l,u,d,h;async function g(){c=await o(e.POWER_ON.key,e.POWER_ON.defaultValue),s=await o(e.API_KEY.key,e.API_KEY.defaultValue);const t=await o(e.FUNCAPTCHA.key,e.FUNCAPTCHA.defaultValue);l=t.delayClick,u=t.loop,d=t.isActive,h=t.maxImageCaptcha}let f=!1,m=[];console.log("This is Funcaptcha");async function p(){console.log("Đã vào captchaClickImage1"),n("captchaClickImage1","green");let e=x(".challenge-instructions-container");if(!e)return;const t=()=>{i(document.querySelector('[class*="restart-button"]'))};e=e.trim(),l<1e3&&(l=1e3);let o="";for(let i=0;i<500;i++){if(i>0){if(await r(l),C(['div[class*="tile-game-fail box screen"]','div[class*="match-game-fail box screen"]']))return u&&(n("Restart button...","red"),t()),n("Failed to solve captcha","red"),void console.log("Giải captcha thất bại");if(C(['div[class*="error box screen"]']))return u&&document.querySelector('div[class*="error box screen"] button').click(),n("Failed to solve captcha","red"),void console.log("Giải captcha thất bại");if(C(['div[class*="victory box screen"]']))return console.log("Giải captcha thành công"),void n("Successfully solved captcha","green")}n("Get image...","red");const c=await w(o);if(!c)continue;o=c;const s=await a(o);if(!s)return console.error("Failed to fetch image base64 for URL:",o),n("Failed to fetch image base64 for URL","red"),void(u&&t());let d=null;for(let o=0;o<3;o++){const r=await v(s,e,30);if(console.log("This is taskResult",r),2===o&&(!r||r.errorDescription))return n(r?.errorDescription||"No task result","red"),void(u&&(n("Restart button...","red"),t()));if(r&&r.result){d=parseInt(r.result.index,10);break}}n("Clicking...","red"),document.querySelector('button[aria-label*="Image '+d+'"]').click()}}async function y(){console.log("Đã vào captchaClickImage2"),n("captchaClickImage2","green");let e=x("#game_children_text");if(e){e=e.trim(),e.endsWith(".")&&(e=e.slice(0,-1)),l<1e3&&(l=1e3);for(let t=0;t<500;t++){if(t>0){await r(l);const e=await k(['div[class*="error box screen"] button',"#wrong_children_button"],1);if(e)return u&&e.click(),console.log("Giải captcha thất bại"),void n("Failed to solve captcha","red");if(E('[id="victoryScreen"]'))return console.log("Giải captcha thành công"),void n("Successfully solved captcha","green")}n("Get image...","red");const o=document.querySelector("#game_challengeItem_image");if(!o)continue;const i=await a(o,{timeout:5e3,maxRetries:3});if(!i)return n("No imageBase64","green"),void(u&&document.querySelector('a[aria-label="Start over with a different challenge" i]').click());const c=await v(i,e,20);if(!c||c.errorDescription)return n(c?.errorDescription||"No task result","red"),void(u&&document.querySelector('a[aria-label="Start over with a different challenge" i]').click());if("Server 500"===c.result)continue;const s=c.result.index;n("Clicking...","red"),await k(['[aria-label*="Image '+s+'" i]'],1e3)&&document.querySelector('[aria-label*="Image '+s+'" i]').click()}}}async function b(){console.log("Da vao captchaClickButton"),n("captchaClickButton","green"),console.log("Gia tri MAX_IMAGE_CAPTCHA",h);const e=()=>{i(document.querySelector('[class*="restart-button"]'))};let t=x(".match-game .text");if(!t)return;console.log("Text captcha tren",t);const o=t.match(/\(.*\b(\d+)\)$/);if(o){const e=parseInt(o[1],10);if(console.log("So lon nhat trong dau ngoac:",e),e>h)return void n(`Image > ${h}, stop function`,"red")}t=t.split("(")[0].trim(),console.log("Text captcha giua",t),t.endsWith(".")&&(t=t.slice(0,-1)),console.log("Text captcha cuoi cung",t);let c="";for(let o=0;o<500;o++){if(o>0){if(await r(l),C(['div[class*="tile-game-fail box screen"]','div[class*="match-game-fail box screen"]']))return u&&(n("Restart captcha","red"),e()),console.log("Giải captcha thất bại"),await T(!1),void n("Failed to solve captcha","red");if(C(['div[class*="error box screen"]']))return u&&document.querySelector('div[class*="error box screen"] button').click(),console.log("Giải captcha thất bại"),await T(!1),void n("Failed to solve captcha","red");if(C(['div[class*="victory box screen"]']))return void n("Successfully solved captcha","green")}n("Get image...","red");const s=await w(c);if(!s)continue;c=s;const d=await a(c);if(!d)return n("No imageBase64","red"),console.error("Failed to fetch image base64 for URL:",c),void(u&&e());let h=null;for(let o=0;o<3;o++){const r=await v(d,t,30);if(console.log("taskResult",r),2===o&&(!r||r.errorDescription))return n(r?.errorDescription||"No task result","red"),void(u&&e());if(r&&r.result){h=parseInt(r.result.index,10);break}}if(!h)return;if(h-=1,h>30)return u&&e(),console.log("Giải captcha thất bại"),void n("Failed to solve captcha","red");n(`Click next (${h})...`,"red");for(let e=0;e<h;e++)e>0&&await r(l),i(document.querySelector(".right-arrow"));n("Click submit...","red"),A(document.querySelector('div[class*="match-game box screen"] button'))}}async function w(e){const t=document.querySelector("body").innerHTML.match(/blob:https:\/\/(.*?)arkoselabs(.*?)\.com\/[a-zA-Z0-9-]+/);return t?e===t[0]?(await r(500),null):t[0]:(await r(500),null)}async function v(e,o,r){try{n("Creating task...","green");const a=JSON.stringify({clientKey:s,task:{type:"FuncaptchaImageTask",imageBase64:e,other:o}}),i=await async function(e){console.log("Vao createTask utils");try{return await t("SOURCE","createTask",e)||(console.error("No response from createTask"),"")}catch(e){return console.error("Failed to create task:",e),""}}(a);if(!i||i.error||!i.taskId)return i.error?(console.log("errorDescription",i.errorDescription),{errorDescription:i.errorDescription}):(n("No taskId","red"),console.warn("[funcaptcha] Failed to create task",i?.errorDescription||""),null);const c=i.taskId;m.push(c),n("Get result...","green");const l=await async function(e,o,r){const n=JSON.stringify({clientKey:e,taskId:o});try{const e=await t("SOURCE","getTaskResult",{data:n,timeWait:r});return e?"fail"===e.status?(console.error("API error:",e),{errorDescription:e.errorDescription}):e.solution?e.solution:e.type?e:(console.error("Invalid API response: missing solution"),null):(console.error("No result returned from getTaskResult"),null)}catch(e){return console.error("Failed to get task result:",e),null}}(s,c,r);return!l||l.errorDescription?l.errorDescription?{errorDescription:l.errorDescription}:null:{result:l}}catch(e){return console.log("ERROR processCaptchaTask",e),null}}async function k(e,t){const o=Math.ceil(t/1e3);for(let t=0;t<o;t++){await new Promise((e=>setTimeout(e,1e3)));for(const t of e){const e=document.querySelector(t);if(e)return e}}return null}function C(e){for(const t of e){const e=document.querySelector(t);if(e)return e}return null}function E(e){return!!document.querySelector(e)}function x(e){const t=document.querySelector(e);return t?t.textContent.trim():null}function A(e){if(!e)return void console.error("Element không hợp lệ.");if(console.log("Vào hàm simulateHumanMouseMovement"),!function(e){const t=e.getBoundingClientRect();return t.width>0&&t.height>0}(e))return void console.error("Element không hiển thị hoặc không có kích thước hợp lệ.");console.log("Đã qua isElementVisible");const t=e.getBoundingClientRect(),o=t.left+t.width/2,r=t.top+t.height/2,n=Math.random()*window.innerWidth/2,a=Math.random()*window.innerHeight/2,c=Math.floor(20*Math.random())+10;!function t(i){if(i>=c)return void console.log("Đã kết thúc di chuyển chuột đến element.");const s=(l=i/c,1-Math.pow(1-l,3));var l;const u=n+(o-n)*s,d=a+(r-a)*s,h=5*(Math.random()-.5),g=5*(Math.random()-.5),f=new MouseEvent("mousemove",{bubbles:!0,clientX:u+h,clientY:d+g});if(document.dispatchEvent(f),0===i){const t=new MouseEvent("mouseover",{bubbles:!0,clientX:u+h,clientY:d+g});e.dispatchEvent(t)}const m=30*Math.random()+20;setTimeout((()=>t(i+1)),m)}(0),i(e)}async function T(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(console.log("Đang check resolvedTaskIds",m),0===m.length)return;const o={taskIds:m,result:e};try{await t("FUNCAPTCHA","reportTask",o)}catch(e){console.error("Failed to send report:",e)}finally{m=[]}}new class{constructor(e,t){this.selectors=e,this.callback=t,this.processedNodes=new Set,this.observer=new MutationObserver(this.handleMutation.bind(this)),this.startObserving()}startObserving(){this.observer.observe(document.body,{childList:!0,subtree:!0})}stopObserving(){this.observer.disconnect()}async handleMutation(e){if(c&&d)for(const t of e){const e=Array.from(t.addedNodes);for(const t of e)if(t.nodeType===Node.ELEMENT_NODE)for(const e of this.selectors)if(t.matches(e)&&!this.processedNodes.has(t))this.processedNodes.add(t),await this.callback(e,[t]);else{const o=Array.from(t.querySelectorAll(e));for(const t of o)this.processedNodes.has(t)||(this.processedNodes.add(t),await this.callback(e,o))}}}}(['button[aria-describedby="descriptionVerify"]','p[aria-label*="Working, please wait" i]','button[data-theme="home.verifyButton"]',".error .button","#wrongTimeout_children_button",'button[id="home_children_button"]'],(async(e,t)=>{if(await g(),!f&&c&&d&&s&&"YOUR_CLIEN_KEY"!==s){console.log("Vào đến DOMObserver");try{f=!0,await r(1e3);const e=await k(['div[class*="error box screen"] button',"#wrong_children_button"],1e3);if(e)return u&&e.click(),void console.log("Giải captcha thất bại");for(let e=0;e<10;e++){const e=await k(['button[data-theme="home.verifyButton"]','button[id="home_children_button"]','button[aria-describedby="descriptionVerify"]'],1e3);if(e?(console.log("[funcaptcha] Click verifyButton"),i(e),m=[]):console.log("[funcaptcha] không tìm thấy verifyButton"),E(".challenge-instructions-container"))await p();else if(E(".match-game .text"))await b();else{if(!E("#game_children_text")){console.log("[funcaptcha] Không tìm thấy captcha");continue}await y()}console.log("[funcaptcha] chay xong findElement");break}}catch(e){console.error("Đã bị lỗi",e)}finally{f=!1}}})),(async()=>{await g()})()})();